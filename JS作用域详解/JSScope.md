# JavaScript作用域和作用域链

## 执行环境
执行环境定义了变量和函数有权访问的其他数据，决定了他们各自的行为，每个执行环境都有与之对应的变量对象，保存着该环境中定义的所有变量和函数。我们无法通过代码来访问变量对象，但是解析器在处理数据时会在后台使用到它。

执行环境有全局执行环境（也称为全局环境）和函数执行环境之分，执行环境如其名是在运行和执行代码的时候才存在的，所以我们运行浏览器的时候会创建全局的执行环境，在调用函数时，会创建函数执行环境。

### 全局执行环境
全局执行环境是最外围的一个执行环境，在web浏览器中，我们可以认为它是window对象，因此所有的全局变量和函数都是作为window对象的属性和方法创建的。代码载入浏览器时，全局环境被创建，关闭网页或者关闭浏览器时全局环境被销毁。

### 函数执行环境
每个函数都有自己的执行环境，当执行流进入一个函数时，函数的环境就被推入一个环境栈中，当函数执行完毕后，栈将其环境弹出，把控制权返回给之前的执行环境。

## 作用域和作用于链
### 全局作用域和局部作用域
全局作用域可以在代码中的任何地方都能被访问。
局部作用域一般只在固定的代码片段内可以访问得到。

### 作用域链
全局作用域和局部作用域中变量的访问权限，其实是由作用域链决定的，每次进入一个新的执行环境，都会创建一个用于搜索变量和函数的作用域链。作用域链是函数被创建的作用域中对象的集合。作用域链可以保证对执行环境有权访问的所有变量和函数的有序访问。

作用域链的最前端始终是当前执行的代码所在环境的变量对象（如果该环境是函数，则将其活动对象作为变量对象），下一个变量对象来自包含环境（包含当前运行环境的环境），下一个变量对象来自包含环境的包含环境，依次往上，直到全局执行环境的变量对象。全局执行环境的变量对象始终是作用域链中的最后一个对象。

标识符解析是沿着作用域一级一级地向上搜索标识符的过程。搜索过程始终是从作用域的前端逐渐地向后回溯，直到找到标识符。

其实，可以把作用域链想象成如下图所示：（里面能访问外面的，外面的不能访问里面的）
![作用域链图解](./作用域链.gif)

### 知识点总结
* 执行环境决定了变量的生命周期，以及哪部分代码可以访问其中的变量
* 执行环境有全局执行环境（全局环境）和局部执行环境之分
* 每次进入一个新的执行环境，都会创建一个用于搜索变量和函数的作用域链
* 函数的局部环境可以访问函数作用域中的变量和函数，也可以访问其父环境，乃至全局环境中的变量和函数
* 全局环境只能访问全局环境的变量和函数，不能直接访问局部环境中的任何数据
* 变量的执行环境有助于确定应该如何释放内存

## 提升
### 变量提升

看如下代码：

> <pre>var name = "haha";
function changeName(){
    console.log(name);
    var name = "xixi";
}
changeName();   // undefined
console.log(name);   // haha</pre> 

这里分析下为什么changeName()输出结果为undefined，changeName()的作用域链：自己的变量对象---->全局变量对象。解析器在函数执行环境中发现变量name，因此不会再向全局环境的变量对象中寻找。但是解析器在解析第三句代码时，还不知道变量name的值，也就是说只知道有变量name，但是不知道它具体的值，因此输出是undefined。所以上述代码其实可以写成下面的形式：

> <pre>var name = "haha"
function changeName(){
    var name;
    console.log(name);
    name= "xixi";
}
changeName();
console.log(name);</pre>

这就是<strong>变量提升</strong>。变量提升就是把变量提升到函数的顶部，需要注意的是，变量提升只是提升变量的声明，不会把变量的值也提升上来。

### 函数提升
在JavaScript中函数的创建方式有三种：函数声明（静态的），函数表达式（函数字面量），函数构造法（动态的）。

> <pre>// 函数声明
function myTest(){};
// 函数表达式
var myTest = function(){}
// 函数构造法
var myTest = new Function("para1","para2",...,"function body")</pre>

这里面只有函数声明的形式才能被提升！